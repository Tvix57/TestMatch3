{"version":3,"sources":["file:///F:/git/TestMatch3/assets/Scripts/Session/GameoverListener.ts"],"names":["GameoverListener","AppRoot","Types","constructor","_welfare","_lifeTime","_adsContext","_dialogFactory","_restoreConfig","endGameDialog","_isShow","AddHandler","OnAgeChanged","OnLife","OnLifeChanged","OnParameterChanged","type","Get","MakePauseAndShowDialog","GetLife","GetAge","Age","AddDialogLauncher","launcher","CreateDialog","isOk","getInstance","ResolveStatistic","ResolveGameReporter","ReportLastChance","Happiness","Health","ReportGameOver","toString","Show","ShowAds","ResolveVideoreward","isReward","AddLifeMonth","lifeExtendBy","Add","welfareIncreaseBy"],"mappings":"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","sourcesContent":["/**\r\n *\r\n * GameoverListener.ts\r\n * db://assets/Scripts/Game/GameoverListener.ts\r\n *\r\n */\r\n\r\nimport { AdsContext } from \"../Ads/AdsContext\";\r\nimport { AppRoot } from \"../Application/AppRoot\";\r\nimport { ILifeHandler, Lifetime } from \"../Game/Lifetime\";\r\nimport { Loop } from \"../Game/Loop\";\r\nimport { Types } from \"../Game/Types\";\r\nimport { IWelfareHandler, IWelfare } from \"../Game/Welfare\";\r\nimport { DialogFactory } from \"../Scene/DialogFactory\";\r\nimport { IDialogLauncher } from \"./TransferHandlers\";\r\n\r\nexport type GameoverConfig = {\r\n    lifeExtendBy:number,\r\n    welfareIncreaseBy:number\r\n}\r\n\r\nexport class GameoverListener implements ILifeHandler, IWelfareHandler \r\n{\r\n    private endGameDialog?:IDialogLauncher\r\n    private _isShow:boolean = false\r\n\r\n    constructor(\r\n        private _welfare: IWelfare,\r\n        private _lifeTime: Lifetime,\r\n        private _adsContext:AdsContext,\r\n        private _dialogFactory:DialogFactory,\r\n        private _restoreConfig:GameoverConfig\r\n    ) {\r\n        _welfare.AddHandler(this)\r\n        _lifeTime.AddHandler(this)\r\n    }\r\n\r\n    OnAgeChanged(): void {\r\n        this.OnLife();\r\n    }\r\n    OnLifeChanged(): void {\r\n        this.OnLife();\r\n    }\r\n    OnParameterChanged(type: Types): void {\r\n        if (this._welfare.Get(type) <= 0) {\r\n            this.MakePauseAndShowDialog(type)\r\n        }\r\n    }\r\n\r\n    private OnLife() {\r\n        if (this._lifeTime.GetLife() <= this._lifeTime.GetAge()) {\r\n            this.MakePauseAndShowDialog(Types.Age)\r\n        }\r\n    }\r\n\r\n    AddDialogLauncher(launcher:IDialogLauncher)\r\n    {\r\n        this.endGameDialog = launcher\r\n    }\r\n\r\n    private MakePauseAndShowDialog(type: Types)\r\n    {\r\n        if(this._isShow) return\r\n        this._isShow = true\r\n\r\n        this._dialogFactory.CreateDialog((isOk)=>{\r\n            this._isShow = false\r\n            AppRoot.getInstance.ResolveStatistic().ResolveStatistic().ResolveGameReporter().ReportLastChance(isOk)\r\n            if(!isOk) {\r\n                if (type === Types.Age || type === Types.Happiness || type === Types.Health) {\r\n                    AppRoot.getInstance.ResolveStatistic().ResolveStatistic().ResolveGameReporter().ReportGameOver(this._lifeTime.GetAge(),type.toString()) ///// fixme can be error\r\n                } else {\r\n                    AppRoot.getInstance.ResolveStatistic().ResolveStatistic().ResolveGameReporter().ReportGameOver(this._lifeTime.GetAge(), \"Restart\")\r\n                }\r\n                this.endGameDialog?.Show()\r\n            } \r\n            else {\r\n                this.ShowAds(type)\r\n            }\r\n        })\r\n    }\r\n\r\n    private ShowAds(type: Types)\r\n    {\r\n        this._adsContext.ResolveVideoreward().Show((isReward)=>{\r\n            if(type === Types.Age){\r\n                this._lifeTime.AddLifeMonth(this._restoreConfig.lifeExtendBy)\r\n            }\r\n            else{\r\n                this._welfare.Add(Types.Happiness, this._restoreConfig.welfareIncreaseBy)\r\n                this._welfare.Add(Types.Health, this._restoreConfig.welfareIncreaseBy)\r\n            }\r\n        })\r\n    }\r\n}\r\n"]}