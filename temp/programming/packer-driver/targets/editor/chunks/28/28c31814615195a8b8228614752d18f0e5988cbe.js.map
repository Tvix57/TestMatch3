{"version":3,"sources":["file:///F:/git/TestMatch3/assets/Scripts/Scene/GameScene/GameSceneComponent.ts"],"names":["_decorator","Component","instantiate","Label","Prefab","tween","UITransform","Vec3","GameScenePresenter","AppRoot","BallColor","BallComponent","ccclass","property","GameSceneComponent","_presenter","_balls","onEnable","getInstance","ResolveGameContext","ResolveGame","ResolveField","ResovleSaveState","ResolveSaveContext","GetCurrentSaveState","LoadData","onDisable","SaveCurrentGame","SetName","newName","nameLabel","string","UpdateScore","newScore","scoreLabel","ShowNewField","data","callback","length","Array","fill","map","forEach","row","i","color","j","ballPrefab","field","node","addChild","cmpBall","getComponent","SetColor","SetClick","OnBallClick","x","y","cmpUI","addBallTween","width","height","start","RemoveBalls","tweens","NONE","push","hideBall","animationAwait","then","DropDownBalls","position","callPromise","Promise","resolve","count","to","from","setPosition","set"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAASA,MAAAA,U,OAAAA,U;AAAYC,MAAAA,S,OAAAA,S;AAAWC,MAAAA,W,OAAAA,W;AAAaC,MAAAA,K,OAAAA,K;AAAaC,MAAAA,M,OAAAA,M;AAAQC,MAAAA,K,OAAAA,K;AAAqDC,MAAAA,W,OAAAA,W;AAAaC,MAAAA,I,OAAAA,I;;AAC3HC,MAAAA,kB,iBAAAA,kB;;AACAC,MAAAA,O,iBAAAA,O;;AACAC,MAAAA,S,iBAAAA,S;;AACAC,MAAAA,a,iBAAAA,a;;;;;;;;;OACH;AAAEC,QAAAA,OAAF;AAAWC,QAAAA;AAAX,O,GAAwBb,U;;oCAGjBc,kB,WADZF,OAAO,CAAC,oBAAD,C,UAEHC,QAAQ,CAACV,KAAD,C,UAGRU,QAAQ,CAACV,KAAD,C,UAGRU,QAAQ,CAACP,WAAD,C,UAGRO,QAAQ,CAACT,MAAD,C,2BAXb,MACaU,kBADb,SACwCb,SADxC,CACkD;AAAA;AAAA;;AAAA;;AAAA;;AAAA;;AAAA;;AAAA,eAatCc,UAbsC;AAAA,eActCC,MAdsC,GAcT,EAdS;AAAA;;AAe9C;AAEAC,QAAAA,QAAQ,GAAS;AACb,eAAKF,UAAL,GAAkB;AAAA;AAAA,wDAAuB,IAAvB,EACuB;AAAA;AAAA,kCAAQG,WAAR,CAAoBC,kBAApB,GAAyCC,WAAzC,GAAuDC,YAAvD,EADvB,EAEuB;AAAA;AAAA,kCAAQH,WAAR,CAAoBI,gBAApB,GAAuCC,kBAAvC,GAA4DC,mBAA5D,EAFvB,CAAlB;;AAIA,eAAKT,UAAL,CAAiBU,QAAjB;AACH;;AAESC,QAAAA,SAAS,GAAS;AAAA;;AACxB,mCAAKX,UAAL,sCAAiBY,eAAjB;AACH;;AAEDC,QAAAA,OAAO,CAACC,OAAD,EAAkB;AACrB,eAAKC,SAAL,CAAeC,MAAf,GAAwBF,OAAxB;AACH;;AAEDG,QAAAA,WAAW,CAACC,QAAD,EAAmB;AAC1B,eAAKC,UAAL,CAAgBH,MAAhB,GAAyBE,QAAzB;AACH;;AAEDE,QAAAA,YAAY,CAACC,IAAD,EAAgCC,QAAhC,EAAuD;AAC/D,cAAI,CAAC,KAAKrB,MAAL,CAAYsB,MAAjB,EAAyB;AACrB,iBAAKtB,MAAL,GAAc,IAAIuB,KAAJ,CAAUH,IAAI,CAACE,MAAf,EAAuBE,IAAvB,CAA4B,IAA5B,EAAkCC,GAAlC,CAAsC,MAAM,IAAIF,KAAJ,CAAUH,IAAI,CAACE,MAAf,EAAuBE,IAAvB,CAA4B,IAA5B,CAA5C,CAAd;AACAJ,YAAAA,IAAI,CAACM,OAAL,CAAa,CAACC,GAAD,EAAMC,CAAN,KAAY;AACrBD,cAAAA,GAAG,CAACD,OAAJ,CAAY,CAACG,KAAD,EAAQC,CAAR,KAAc;AACtB,qBAAK9B,MAAL,CAAY4B,CAAZ,EAAeE,CAAf,IAAoB5C,WAAW,CAAC,KAAK6C,UAAN,CAA/B;AACA,qBAAKC,KAAL,CAAWC,IAAX,CAAgBC,QAAhB,CAAyB,KAAKlC,MAAL,CAAY4B,CAAZ,EAAeE,CAAf,CAAzB;AACH,eAHD;AAIH,aALD;AAMH;;AACDV,UAAAA,IAAI,CAACM,OAAL,CAAa,CAACC,GAAD,EAAMC,CAAN,KAAY;AACrBD,YAAAA,GAAG,CAACD,OAAJ,CAAY,CAACG,KAAD,EAAQC,CAAR,KAAc;AACtB,kBAAIK,OAAO,GAAG,KAAKnC,MAAL,CAAY4B,CAAZ,EAAeE,CAAf,EAAkBM,YAAlB;AAAA;AAAA,iDAAd;;AACAD,cAAAA,OAAO,CAACE,QAAR,CAAiBR,KAAjB;AACAM,cAAAA,OAAO,CAACG,QAAR,CAAiB,MAAM;AAAC,qBAAKvC,UAAL,CAAiBwC,WAAjB,CAA6B;AAACC,kBAAAA,CAAC,EAACZ,CAAH;AAAMa,kBAAAA,CAAC,EAACX;AAAR,iBAA7B;AAAyC,eAAjE;;AACA,kBAAIY,KAAK,GAAG,KAAK1C,MAAL,CAAY4B,CAAZ,EAAeE,CAAf,EAAkBM,YAAlB,CAA+B9C,WAA/B,CAAZ;;AACA,mBAAKqD,YAAL,CAAkB,KAAK3C,MAAL,CAAY4B,CAAZ,EAAeE,CAAf,CAAlB,EACG;AAACU,gBAAAA,CAAC,EAACE,KAAK,CAACE,KAAN,GAAc,CAAd,GAAkBF,KAAK,CAACE,KAAN,GAAehB,CAApC;AACCa,gBAAAA,CAAC,EAACC,KAAK,CAACG,MAAN,GAAe,CAAf,GAAmBH,KAAK,CAACG,MAAN,GAAef;AADrC,eADH,EAGG;AAACU,gBAAAA,CAAC,EAACE,KAAK,CAACE,KAAN,GAAc,CAAd,GAAkBF,KAAK,CAACE,KAAN,GAAehB,CAApC;AACCa,gBAAAA,CAAC,EAAC,KAAKT,KAAL,CAAWa,MAAX,IAAqBH,KAAK,CAACG,MAAN,GAAe,CAAf,GAAmBH,KAAK,CAACG,MAAN,GAAef,CAAvD;AADH,eAHH,EAIkEgB,KAJlE;AAKH,aAVD;AAWH,WAZD;AAaH;;AAEgB,cAAXC,WAAW,CAAC3B,IAAD,EAAgCC,QAAhC,EAAuD;AACpE,cAAI2B,MAAM,GAAGzB,KAAK,EAAlB;AACAH,UAAAA,IAAI,CAACM,OAAL,CAAa,CAACC,GAAD,EAAMC,CAAN,KAAY;AACrBD,YAAAA,GAAG,CAACD,OAAJ,CAAY,CAACG,KAAD,EAAQC,CAAR,KAAc;AACtB,kBAAID,KAAK,KAAK;AAAA;AAAA,0CAAUoB,IAAxB,EAA8B;AAC1B;AACA,oBAAIP,KAAK,GAAG,KAAK1C,MAAL,CAAY4B,CAAZ,EAAeE,CAAf,EAAkBM,YAAlB,CAA+B9C,WAA/B,CAAZ;;AACA0D,gBAAAA,MAAM,CAACE,IAAP,CAAY,KAAKC,QAAL,CAAc,KAAKnD,MAAL,CAAY4B,CAAZ,EAAeE,CAAf,CAAd,EACA;AAACU,kBAAAA,CAAC,EAACE,KAAK,CAACE,KAAN,GAAc,CAAd,GAAkBF,KAAK,CAACE,KAAN,GAAehB,CAApC;AACCa,kBAAAA,CAAC,EAAC,KAAKT,KAAL,CAAWa,MAAX,IAAqBH,KAAK,CAACG,MAAN,GAAe,CAAf,GAAmBH,KAAK,CAACG,MAAN,GAAef,CAAvD;AADH,iBADA,CAAZ;AAIH;AACJ,aATD;AAUH,WAXD;AAaA,eAAKsB,cAAL,CAAoBJ,MAApB,EAA4BK,IAA5B,CAAiC,MAAM;AAAChC,YAAAA,QAAQ,QAAR,YAAAA,QAAQ;AAAK,WAArD;AACH;;AAEkB,cAAbiC,aAAa,CAAClC,IAAD,EAAgCC,QAAhC,EAAuD;AACtE,cAAI2B,MAAM,GAAGzB,KAAK,EAAlB;AACAH,UAAAA,IAAI,CAACM,OAAL,CAAa,CAACC,GAAD,EAAMC,CAAN,KAAY;AACrBD,YAAAA,GAAG,CAACD,OAAJ,CAAY,CAACG,KAAD,EAAQC,CAAR,KAAc;AACtB,kBAAIY,KAAK,GAAG,KAAK1C,MAAL,CAAY4B,CAAZ,EAAeE,CAAf,EAAkBM,YAAlB,CAA+B9C,WAA/B,CAAZ;;AACA,kBAAI,KAAKU,MAAL,CAAY4B,CAAZ,EAAeE,CAAf,EAAkByB,QAAlB,CAA2Bf,CAA3B,KAAiCE,KAAK,CAACE,KAAN,GAAe,CAAf,GAAmBF,KAAK,CAACE,KAAN,GAAehB,CAAnE,IACA,KAAK5B,MAAL,CAAY4B,CAAZ,EAAeE,CAAf,EAAkByB,QAAlB,CAA2Bd,CAA3B,KAAiCC,KAAK,CAACG,MAAN,GAAe,CAAf,GAAmBH,KAAK,CAACG,MAAN,GAAef,CADvE,EAC0E;AAClE,oBAAI,KAAK9B,MAAL,CAAY4B,CAAZ,EAAeE,CAAf,EAAkByB,QAAlB,CAA2Bd,CAA3B,GAA+B,KAAKT,KAAL,CAAWa,MAA9C,EAAsD;AAClD,uBAAK7C,MAAL,CAAY4B,CAAZ,EAAeE,CAAf,EAAkBM,YAAlB;AAAA;AAAA,sDAA+CC,QAA/C,CAAwDR,KAAxD;AACH;;AACDmB,gBAAAA,MAAM,CAACE,IAAP,CAAY,KAAKP,YAAL,CAAkB,KAAK3C,MAAL,CAAY4B,CAAZ,EAAeE,CAAf,CAAlB,EACR;AAACU,kBAAAA,CAAC,EAACE,KAAK,CAACE,KAAN,GAAe,CAAf,GAAmBF,KAAK,CAACE,KAAN,GAAehB,CAArC;AACCa,kBAAAA,CAAC,EAACC,KAAK,CAACG,MAAN,GAAe,CAAf,GAAmBH,KAAK,CAACG,MAAN,GAAef;AADrC,iBADQ,CAAZ;AAGP;AACJ,aAXD;AAYH,WAbD;AAeA,eAAKsB,cAAL,CAAoBJ,MAApB,EAA4BK,IAA5B,CAAiC,MAAM;AAAChC,YAAAA,QAAQ,QAAR,YAAAA,QAAQ;AAAK,WAArD;AACH;;AAEO+B,QAAAA,cAAc,CAACJ,MAAD,EAA6B;AAC/C,cAAIQ,WAAW,GAAG,IAAIC,OAAJ,CAAmBC,OAAD,IAAa;AAC7C,gBAAIC,KAAK,GAAG,CAAZ;AACAX,YAAAA,MAAM,CAACtB,OAAP,CAAerC,KAAK,IAAI;AACpBA,cAAAA,KAAK,CAACyD,KAAN;AACA,gBAAEa,KAAF;;AACA,kBAAGA,KAAK,KAAKX,MAAM,CAAC1B,MAApB,EAA4B;AACxBoC,gBAAAA,OAAO;AACV;AACJ,aAND;AAOH,WATiB,CAAlB;AAUA,iBAAOF,WAAP;AACH;;AAEOb,QAAAA,YAAY,CAACV,IAAD,EAAa2B,EAAb,EAAwCC,IAAxC,EAAsE;AACtF,cAAIA,IAAJ,EAAU;AACN5B,YAAAA,IAAI,CAAC6B,WAAL,CAAiBD,IAAI,CAACrB,CAAtB,EAAyBqB,IAAI,CAACpB,CAA9B,EAAiC,CAAjC;AACH;;AACD,iBAAOpD,KAAK,CAAC4C,IAAD,CAAL,CAAY2B,EAAZ,CAAe,GAAf,EAAoB;AAACL,YAAAA,QAAQ,EAAC,IAAIhE,IAAJ,CAASqE,EAAE,CAACpB,CAAZ,EAAeoB,EAAE,CAACnB,CAAlB,EAAqB,CAArB;AAAV,WAApB,CAAP;AACH;;AAEOU,QAAAA,QAAQ,CAAClB,IAAD,EAAa2B,EAAb,EAAwC;AACpD,iBAAOvE,KAAK,CAAC4C,IAAD,CAAL,CAAY8B,GAAZ,CAAgB;AAACR,YAAAA,QAAQ,EAAC,IAAIhE,IAAJ,CAASqE,EAAE,CAACpB,CAAZ,EAAeoB,EAAE,CAACnB,CAAlB,EAAqB,CAArB;AAAV,WAAhB,CAAP;AACH;;AA3H6C,O;;;;;iBAE3B,I;;;;;;;iBAGC,I;;;;;;;iBAGC,I;;;;;;;iBAGA,I","sourcesContent":["import { _decorator, Component, instantiate, Label, Node, Prefab, tween, Tween, TweenSystem, TweenAction, TweenEasing, UITransform, Vec3 } from 'cc';\r\nimport { GameScenePresenter } from './GameScenePresenter';\r\nimport { AppRoot } from '../../Application/AppRoot';\r\nimport { BallColor } from '../../Enums/BallColor';\r\nimport { BallComponent } from './BallComponent';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('GameSceneComponent')\r\nexport class GameSceneComponent extends Component {\r\n    @property(Label)\r\n    nameLabel: Label = null!\r\n\r\n    @property(Label)\r\n    scoreLabel: Label = null!\r\n\r\n    @property(UITransform)\r\n    field: UITransform = null!\r\n\r\n    @property(Prefab)\r\n    ballPrefab: Prefab = null!\r\n\r\n    private _presenter?: GameScenePresenter\r\n    private _balls: Array<Array<Node>> = []\r\n    // private animationPromise: Promise<void> = new Promise<void>(() => {})\r\n\r\n    onEnable(): void {\r\n        this._presenter = new GameScenePresenter(this, \r\n                                                 AppRoot.getInstance.ResolveGameContext().ResolveGame().ResolveField(),\r\n                                                 AppRoot.getInstance.ResovleSaveState().ResolveSaveContext().GetCurrentSaveState())\r\n\r\n        this._presenter!.LoadData()\r\n    }\r\n\r\n    protected onDisable(): void {\r\n        this._presenter?.SaveCurrentGame()\r\n    }\r\n\r\n    SetName(newName: string) {\r\n        this.nameLabel.string = newName\r\n    }\r\n\r\n    UpdateScore(newScore: string) { \r\n        this.scoreLabel.string = newScore\r\n    }\r\n\r\n    ShowNewField(data: Array<Array<BallColor>>, callback?: () => void) {\r\n        if (!this._balls.length) {\r\n            this._balls = new Array(data.length).fill(null).map(() => new Array(data.length).fill(null));\r\n            data.forEach((row, i) => {\r\n                row.forEach((color, j) => {\r\n                    this._balls[i][j] = instantiate(this.ballPrefab)\r\n                    this.field.node.addChild(this._balls[i][j])\r\n                })\r\n            })\r\n        }\r\n        data.forEach((row, i) => {\r\n            row.forEach((color, j) => {\r\n                let cmpBall = this._balls[i][j].getComponent(BallComponent)!\r\n                cmpBall.SetColor(color)\r\n                cmpBall.SetClick(() => {this._presenter!.OnBallClick({x:i, y:j})})\r\n                let cmpUI = this._balls[i][j].getComponent(UITransform)!\r\n                this.addBallTween(this._balls[i][j],\r\n                   {x:cmpUI.width / 2 + cmpUI.width  * i, \r\n                    y:cmpUI.height / 2 + cmpUI.height * j},\r\n                   {x:cmpUI.width / 2 + cmpUI.width  * i, \r\n                    y:this.field.height + (cmpUI.height / 2 + cmpUI.height * j)}).start()\r\n            })\r\n        })\r\n    }\r\n\r\n    async RemoveBalls(data: Array<Array<BallColor>>, callback?: () => void) {\r\n        let tweens = Array<Tween<Node>>()\r\n        data.forEach((row, i) => {\r\n            row.forEach((color, j) => {\r\n                if (color === BallColor.NONE) {\r\n                    /// add burn animation\r\n                    let cmpUI = this._balls[i][j].getComponent(UITransform)!\r\n                    tweens.push(this.hideBall(this._balls[i][j], \r\n                                {x:cmpUI.width / 2 + cmpUI.width  * i,\r\n                                 y:this.field.height + (cmpUI.height / 2 + cmpUI.height * j)}))\r\n                        \r\n                }\r\n            })\r\n        })\r\n\r\n        this.animationAwait(tweens).then(() => {callback?.()})\r\n    }\r\n\r\n    async DropDownBalls(data: Array<Array<BallColor>>, callback?: () => void) {\r\n        let tweens = Array<Tween<Node>>()\r\n        data.forEach((row, i) => {\r\n            row.forEach((color, j) => {\r\n                let cmpUI = this._balls[i][j].getComponent(UITransform)!\r\n                if (this._balls[i][j].position.x !== cmpUI.width  / 2 + cmpUI.width  * i ||\r\n                    this._balls[i][j].position.y !== cmpUI.height / 2 + cmpUI.height * j) {\r\n                        if (this._balls[i][j].position.y > this.field.height) {\r\n                            this._balls[i][j].getComponent(BallComponent)!.SetColor(color)\r\n                        }\r\n                        tweens.push(this.addBallTween(this._balls[i][j],\r\n                            {x:cmpUI.width  / 2 + cmpUI.width  * i, \r\n                             y:cmpUI.height / 2 + cmpUI.height * j}))\r\n                }\r\n            })\r\n        })\r\n\r\n        this.animationAwait(tweens).then(() => {callback?.()})\r\n    }\r\n\r\n    private animationAwait(tweens: Array<Tween<Node>>) {\r\n        let callPromise = new Promise<void>((resolve) => {\r\n            let count = 0\r\n            tweens.forEach(tween => {\r\n                tween.start()\r\n                ++count\r\n                if(count === tweens.length) {\r\n                    resolve()\r\n                }\r\n            })\r\n        })\r\n        return callPromise\r\n    }\r\n\r\n    private addBallTween(node: Node, to:{x: number, y: number}, from?:{x: number, y: number}) {\r\n        if (from) {\r\n            node.setPosition(from.x, from.y, 0)\r\n        }       \r\n        return tween(node).to(0.5, {position:new Vec3(to.x, to.y, 0)})\r\n    }\r\n\r\n    private hideBall(node: Node, to:{x: number, y: number}) {\r\n        return tween(node).set({position:new Vec3(to.x, to.y, 0)})\r\n    }\r\n\r\n\r\n\r\n}\r\n\r\n\r\n"]}